<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>CRELAY by ondrej1024</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">CRELAY</h1>
      <h2 class="project-tagline">Controlling relay cards for home automation with a Linux software</h2>
      <a href="https://github.com/ondrej1024/crelay" class="btn">View on GitHub</a>
      <a href="https://github.com/ondrej1024/crelay/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/ondrej1024/crelay/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <h1>
<a id="crelay" class="anchor" href="#crelay" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>crelay</h1>

<h4>
<a id="controlling-different-relay-cards-for-home-automation-with-a-linux-software" class="anchor" href="#controlling-different-relay-cards-for-home-automation-with-a-linux-software" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Controlling different relay cards for home automation with a Linux software</h4>

<h3>
<a id="about" class="anchor" href="#about" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>About</h3>

<p>Ever bougth a cute little USB relay card and wanted to use it on a Linux based device or computer? Chances are that your were out of luck because the Linux software support for the card provided by the manufacturer was non existent. Conrad, Sainsmart, Denkovi and friends are still ignoring the existence of this operating system. That's why I started this project.  </p>

<p>This software is intended to run on Linux systems to control USB relay cards from different manufacturers in a unified way. It provides several interfaces for controlling the relays locally or remotely via the network. The relays can be controlled by a human being via a device like smartphone or web browser, or directly by an intelligent device as used in the Internet of Things.<br>
The software was designed with the following requirements in mind:  </p>

<ul>
<li>simple, intuitive usage and interface</li>
<li>as little dependencies as possible (libraries, drivers, external programs)</li>
<li>runs on a variety of Linux distributions, different hardware platforms</li>
<li>lightweight, can run on simple devices</li>
<li>easily expandable (adding relay card types and user interfaces)</li>
</ul>

<p>New relay cards support can be added by providing the cards driver code for detecting the card, reading and setting the relays.
Currently the following relay cards are supported:  </p>

<ul>
<li>
<a href="http://www.conrad.de/ce/de/product/393905">Conrad USB 4-channel relay card</a>, 
see <a href="https://github.com/ondrej1024/crelay#note-1-conrad-usb-4-channel-relay-card"><em>Note 1</em></a> below</li>
<li>
<a href="http://www.sainsmart.com/sainsmart-4-channel-5v-usb-relay-board-module-controller-for-automation-robotics.html">Sainsmart USB 4/8-channel relay card</a>, 
see <a href="https://github.com/ondrej1024/crelay#note-2-sainsmart-usb-48-channel-relay-card"><em>Note 2</em></a> below</li>
<li><a href="http://www.ebay.com/itm/For-Smart-Home-5V-USB-Relay-2-Channel-Programmable-Computer-Control-/190950124351">HID API compatible relay cards (1/2/4/8 channel)</a></li>
<li><a href="http://www.sainsmart.com/arduino/sainsmart-16-channel-controller-usb-hid-programmable-control-relay-module.html">Sainsmart USB 16-channel relay control module</a></li>
<li>Generic GPIO controlled relays, 
see <a href="https://github.com/ondrej1024/crelay#note-3-gpio-controlled-relays"><em>Note 3</em></a> below<br>
</li>
</ul>

<p>The used relay card is automatically detected. No complicated port or communication parameter settings required. Just plug in your card and play.  </p>

<p>The following picture shows a high level view on the modular software architecture.  </p>

<p><img src="screenshots/sw-architecture.png" alt="Software architechture">
<br><br></p>

<h3>
<a id="features" class="anchor" href="#features" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Features</h3>

<ul>
<li>Command line mode and daemon mode with Web GUI</li>
<li>Automatic detection of relay card</li>
<li>Reading of current relay states</li>
<li>Setting of new relay states</li>
<li>Single pulse generation on relay contact</li>
<li>HTTP API for external clients (e.g. Smartphone/tablet apps)</li>
<li>Multiple relay card type support<br>
</li>
<li>Support for configuration file with custom parameters
<br>
</li>
</ul>

<h3>
<a id="nice-to-have-wishlist" class="anchor" href="#nice-to-have-wishlist" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Nice to have (wishlist)</h3>

<ul>
<li>Integrated MQTT client</li>
<li><a href="https://thingspeak.com/docs/talkback">ThingSpeak Talkback App</a></li>
<li>Multiple cards support</li>
<li>Access control for Web GUI and HTTP API</li>
<li>Programmable timers for relay actions<br>
<br>
</li>
</ul>

<h3>
<a id="screenshots" class="anchor" href="#screenshots" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Screenshots</h3>

<h4>
<a id="web-gui" class="anchor" href="#web-gui" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Web GUI</h4>

<p><img src="screenshots/crelay-screenshot1.png" alt="Screenshot" title="Web GUI with Conrad card connected"></p>

<h2>
<a id="" class="anchor" href="#" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a><br>
</h2>

<p><img src="screenshots/crelay-screenshot2.png" alt="Screenshot" title="Web GUI with GPIO relays connected">
<br><br></p>

<h4>
<a id="command-line-interface" class="anchor" href="#command-line-interface" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Command line interface</h4>

<pre><code>$ crelay 
crelay, version 0.10

This utility provides a unified way of controlling different types of relay cards.
Currently supported relay cards:
  - Conrad USB 4-channel relay card
  - Sainsmart USB 4/8-channel relay card
  - HID API compatible relay card
  - Sainsmart USB-HID 16-channel relay card
  - Generic GPIO relays
The card which is detected first will be used. 

The program can be run in interactive (command line) mode or in daemon mode with
built-in web server.

Interactive mode:
    crelay -i | [&lt;relay number&gt;] [ON|OFF]

       The state of any relay can be read or it can be changed to a new state.
       If only the relay number is provided then the current state is returned,
       otherwise the relays state is set to the new value provided as second parameter.
       The USB communication port is auto detected. The first compatible device
       found will be used.

Daemon mode:
    crelay -d [&lt;relay1_label&gt; [&lt;relay2_label&gt; [&lt;relay3_label&gt; [&lt;relay4_label&gt;]]]] 

       In daemon mode the built-in web server will be started and the relays
       can be completely controlled via a Web browser GUI or HTTP API.
       Optionally a personal label for each relay can be supplied which will
       be displayed next to the relay name on the web page.

       To access the web interface point your Web browser to the following address:
       http://&lt;my-ip-address&gt;:8000

       To use the HTTP API send a POST or GET request from the client to this URL:
       http://&lt;my-ip-address&gt;:8000/gpio
</code></pre>

<p><br>  </p>

<h3>
<a id="http-api" class="anchor" href="#http-api" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>HTTP API</h3>

<p>An HTTP API is provided to access the server from external clients. This API is compatible with the <a href="https://play.google.com/store/apps/details?id=com.jasonfindlay.pirelay">PiRelay Android app</a>. Therefore the app can be used on your Android phone to control <em>crelay</em> remotely.<br>
I am also considering to add a more universally usable Json format based API in the future.</p>

<ul>
<li>
<p>API url:  </p>

<pre><i>ip_address[:port]</i>/gpio</pre>  </li>
<li>
<p>Method:  </p>

<pre>POST or GET</pre>  </li>
<li><p>Reading relay states<br>
Required Parameter: none  </p></li>
<li>
<p>Setting relay state<br>
Required Parameter: </p>
<pre>pin=[1|2|3|4], status=[0|1|2] where 0=off 1=on 2=pulse</pre>  </li>
<li>
<p>Response from server:  </p>

<pre>
Relay 1:[0|1]
Relay 2:[0|1]
Relay 3:[0|1]
Relay 4:[0|1]
</pre>  

<p><br></p>
</li>
</ul>

<h3>
<a id="installation-from-source" class="anchor" href="#installation-from-source" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Installation from source</h3>

<p>The installation procedure is usually perfomed directly on the target system. Therefore a C compiler and friends should already be installed. Otherwise a cross compilation environment needs to be setup on a PC (this is not described here).  </p>

<ul>
<li>
<p>Install dependencies (package names may vary depending on your distribution):</p>

<pre>
apt-get install libftdi1 libftdi-dev libhidapi-libusb0 libhidapi-dev libusb-1.0-0 libusb-1.0-0-dev
</pre>
</li>
<li>
<p>Build dependencies from source (optional):<br>
On some not so recent Linux distributions (like Debian Weezy) the HIDAPI library is not yet packaged, so it needs to be build from the source code. Follow these instructions to do that:</p>

<pre>
apt-get install libudev-dev libusb-1.0-0-dev
git clone git://github.com/signal11/hidapi.git
./bootstrap
./configure
make
sudo make install
</pre>
</li>
<li>
<p>Clone crelay git repository :  </p>

<pre>
git clone https://github.com/ondrej1024/crelay
cd crelay
</pre>
</li>
<li>
<p>Alternatively get latest source code version :  </p>

<pre>
wget https://github.com/ondrej1024/crelay/archive/master.zip
unzip master.zip
cd crelay-master
</pre>
</li>
<li>
<p>Build and install :  </p>

<pre>
cd src
make [DRV_CONRAD=n] [DRV_SAINSMART=n] [DRV_HIDAPI=n]
sudo make install
</pre>

<p><i>Note:</i> Optionally, you can exclude specific relay card drivers (and their dependencies) from the build, if you don't need them. To do this, specify the driver name as parameter of the "make" command as shown above.  </p>
</li>
</ul>

<p><br></p>

<h3>
<a id="installation-of-prebuilt-binaries" class="anchor" href="#installation-of-prebuilt-binaries" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Installation of prebuilt binaries</h3>

<p>To save you the hassle of building crelay from source, prebuild binaries are provided for selected architectures. Just save the binary for your architecture on your host system and execute it.  </p>

<p>The binaries can be downloaded from the <a href="https://github.com/ondrej1024/crelay/releases/latest">Latest release page</a>.</p>

<p><i>Note:</i> The binaries use shared librabries, so you might need to install the needed libs to your system, if not already done previously:  </p>

<pre>
    apt-get install libftdi1 libhidapi-libusb0 libusb-1.0-0
</pre>  

<p><br></p>

<h3>
<a id="distribution-specific-packages" class="anchor" href="#distribution-specific-packages" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Distribution specific packages</h3>

<p>Currently, there are official OpenWRT packages available for different architectures from the developement snapshot repositories. They can be downloaded here:  </p>

<pre><code>https://downloads.openwrt.org/snapshots/trunk/[arch]/generic/packages/packages/crelay&lt;ver&gt;_&lt;arch&gt;.ipk
</code></pre>

<p>If anyone wants to build packages for other Linux distributions, please feel free to do so and share it here.  </p>

<p><br></p>

<h3>
<a id="configuration" class="anchor" href="#configuration" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Configuration</h3>

<p>When running in daemon mode. the parameters for <em>crelay</em> can be customized via the configuration file <code>crelay.conf</code> which should be placed in the <code>/etc/</code> system folder. An example file is provided together with the programs source code in the <code>conf/</code> folder.</p>

<pre>
################################################
#
# crelay config file
#
# This file is read by crelay in daemon mode
# from /etc/crelay.conf
#
################################################

# HTTP server parameters
################################################
[HTTP server]
server_iface = 0.0.0.0    # listen interface IP address
#server_iface = 127.0.0.1 # to listen on localhost only
server_port  = 8000       # listen port
relay1_label = Device 1   # label for relay 1
relay2_label = Device 2   # label for relay 2
relay3_label = Device 3   # label for relay 3
relay4_label = Device 4   # label for relay 4
relay5_label = Device 5   # label for relay 5
relay6_label = Device 6   # label for relay 6
relay7_label = Device 7   # label for relay 7
relay8_label = Device 8   # label for relay 8
    
# GPIO driver parameters
################################################
[GPIO drv]
#num_relays = 8    # Number of GPIOs connected to relays (1 to 8)
#relay1_gpio_pin = 17   # GPIO pin for relay 1 (17 for RPi GPIO0)
#relay2_gpio_pin = 18   # GPIO pin for relay 2 (18 for RPi GPIO1)
#relay3_gpio_pin = 27   # GPIO pin for relay 3 (27 for RPi GPIO2)
#relay4_gpio_pin = 22   # GPIO pin for relay 4 (22 for RPi GPIO3)
#relay5_gpio_pin = 23   # GPIO pin for relay 5 (23 for RPi GPIO4)
#relay6_gpio_pin = 24   # GPIO pin for relay 6 (24 for RPi GPIO5)
#relay7_gpio_pin = 25   # GPIO pin for relay 7 (25 for RPi GPIO6)
#relay8_gpio_pin = 4    # GPIO pin for relay 8 ( 4 for RPi GPIO7)
    
# Sainsmart driver parameters
################################################
[Sainsmart drv]
num_relays = 4   # Number of relays on the Sainsmart card (4 or 8)
</pre>

<p><br></p>

<h3>
<a id="adding-new-relay-card-drivers" class="anchor" href="#adding-new-relay-card-drivers" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Adding new relay card drivers</h3>

<p>The modular architecture of <em>crelay</em> makes it possible to easily add new relay card drivers.<br>
See example files <code>relay_drv_sample.c</code> and <code>relay_drv_sample.h</code> in the src directory for details on how to write your own low level driver functions.<br>
<br>  </p>

<h3>
<a id="credits" class="anchor" href="#credits" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Credits</h3>

<p>The support for the different relay cards in <em>crelay</em> has only been possible thanks to the valuable contributions of the following people who reverse engineered the communication protocols of the cards and provided the protocol specifications.</p>

<ul>
<li>
<a href="https://github.com/dsacre">Dominic Sacré</a> who discovered the communication protocol of the Conrad USB card</li>
<li>
<a href="https://github.com/darrylb123">Darryl Bond</a>, who discovered the communication protocol of the HID API cards</li>
<li>
<a href="https://github.com/stav09">Steve Crow</a>, who discovered the communication protocol of the Sainsmart USB cards</li>
<li>
<a href="https://github.com/khilman">Kevin Hilman</a>, who implemented and tested the support for the Sainsmart 16-channel control module</li>
<li>
<a href="https://github.com/lunn">Andrew Lunn</a>, who contributed cleanup patches
<br><br>
</li>
</ul>

<h3>
<a id="notes" class="anchor" href="#notes" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Notes</h3>

<h5>
<a id="note-1-conrad-usb-4-channel-relay-card" class="anchor" href="#note-1-conrad-usb-4-channel-relay-card" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a><i>Note 1 (Conrad USB 4-channel relay card)</i>:</h5>

<p>The relay card software provided by Conrad is Windows only and uses a binary runtime DLL which implements the communication protocol between the host computer and the card. Thanks to a raspberrypi.org forum member, the communication protocol was discovered and made public. This made it possible to develop an open source driver for the Conrad card which can run on any Linux distribution.</p>

<p>Earlier versions of this program needed the cp210x kernel driver for the Silabs CP2104 chip with GPIO support. The official in-kernel cp210x driver does not  support GPIO operations. Therefore the Silabs driver from their home page needed to be used:
<a href="http://www.silabs.com/products/mcu/pages/usbtouartbridgevcpdrivers.aspx">http://www.silabs.com/products/mcu/pages/usbtouartbridgevcpdrivers.aspx</a></p>

<p>The current version of <em>crelay</em> uses libusb to talk directly to the CP2104 on the Conrad card, therefore the cp210x kernel driver is <strong>not needed</strong> anymore.<br>
<br>  </p>

<h5>
<a id="note-2-sainsmart-usb-48-channel-relay-card" class="anchor" href="#note-2-sainsmart-usb-48-channel-relay-card" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a><i>Note 2 (Sainsmart USB 4/8-channel relay card)</i>:</h5>

<p>The Sainsmart card uses the FTDI FT245RL chip. This chip is controlled directly through the open source libFTDI library. No Kernel driver is needed. However on most Linux distributions, the <em>ftdi_sio</em> serial driver is automatically loaded when the FT245RL chip is detected. In order to grant the <em>crelay</em> software access to the card, the default driver needs to be unloaded:  </p>

<pre><code>rmmod ftdi_sio
</code></pre>

<p>To prevent automatic loading of the driver, add the following line to /etc/modprobe.d/blacklist.conf:  </p>

<pre><code>blacklist ftdi_sio
</code></pre>

<p>Both 4 and 8 channel versions are supported. However, there seems to be no way to automatically detect which version of the card is used. Therefore the number of relay channles can be configured in the configuration file.  </p>

<p><br>  </p>

<h5>
<a id="note-3-gpio-controlled-relays" class="anchor" href="#note-3-gpio-controlled-relays" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a><i>Note 3 (GPIO controlled relays)</i>:</h5>

<p>Since GPIO pin configuration is strictly device specific, the generic GPIO mode is disabled by default and can only be used in daemon mode. In order to enable it, the specific GPIO pins used as relay control lines have to be specified in the configuration file, <code>[GPIO drv]</code> section.  </p>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/ondrej1024/crelay">CRELAY</a> is maintained by <a href="https://github.com/ondrej1024">ondrej1024</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

            <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-48477283-1");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

  </body>
</html>
